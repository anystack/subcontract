package subcontract_test

import (
	"context"
	"fmt"
	"github.com/anystack/subcontract"
	"testing"
)

func init() {
	_ = fmt.Println
}

func TestDo(t *testing.T) {
	ctx, cancel := context.WithCancel(context.TODO())
	p := subcontract.NewContractor(ctx,
		subcontract.WithSlots(64),
		subcontract.WithContract(func(v interface{}) {
			fmt.Println(v)
		}), subcontract.WithDeliver(func() {
			fmt.Println("switched")
		}))
	p.Do("a", 126508028, 21432)
	p.Do("a", 195276497, 2143)
	p.Do("a", 165002907, 21)
	p.Do("b", 145383777, 21432)
	p.Do("b", 189910665, 2143)
	p.Do("b", 163559177, 21)
	p.Do("c", 193291910, 21432)
	p.Do("c", 196625384, 2143)
	p.Do("c", 127931408, 21)
	p.Do("a", 127931408, 21)
	cancel()
	<-p.Done()
}

func BenchmarkDo(b *testing.B) {
	ctx, cancel := context.WithCancel(context.TODO())
	p := subcontract.NewContractor(ctx,
		subcontract.WithSlots(64),
	)
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		p.Do("a", 195276497, 2143)
		p.Do("b", 145383777, 21432)
		p.Do("c", 127931408, 21)
	}
	cancel()
	<-p.Done()
}

func BenchmarkDoSg(b *testing.B) {
	ctx, cancel := context.WithCancel(context.TODO())
	p := subcontract.NewContractor(ctx,
		subcontract.WithSlots(64),
		subcontract.WithContractor(subcontract.Sg),
	)
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		p.Do("a", 165002907, 21)
		p.Do("b", 163559177, 21)
		p.Do("c", 160070131, 953928)
	}
	cancel()
	<-p.Done()
}

func BenchmarkDoWgContractor(b *testing.B) {
	ctx, cancel := context.WithCancel(context.TODO())
	p := subcontract.NewContractor(ctx,
		subcontract.WithSlots(64),
		subcontract.WithContractor(subcontract.Wg),
	)
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		p.Do("a", 126508028, 21432)
		p.Do("a", 195276497, 2143)
		p.Do("a", 165002907, 21)
		p.Do("a", 145383777, 21432)
		p.Do("a", 189910665, 2143)
		p.Do("a", 163559177, 21)
		p.Do("a", 193291910, 21432)
		p.Do("a", 196625384, 2143)
		p.Do("a", 127931408, 21)
		p.Do("a", 183721869, 21432)
		p.Do("a", 162093163, 2143)
		p.Do("a", 103750125, 21)
		p.Do("a", 163587716, 21432)
		p.Do("a", 103329297, 2143)
		p.Do("a", 113311845, 21)
		p.Do("a", 102902772, 21432)
		p.Do("a", 178049384, 2143)
		p.Do("a", 145409259, 21)
		p.Do("a", 192537932, 21432)
		p.Do("a", 130609642, 2143)
		p.Do("a", 171548844, 21)
		p.Do("a", 126836499, 21432)
		p.Do("a", 102375304, 2143)
		p.Do("a", 165852391, 21)
		p.Do("a", 133532095, 21432)
		p.Do("a", 129246971, 2143)
		p.Do("a", 141447395, 21)
		p.Do("a", 109140482, 21432)
		p.Do("a", 137656821, 2143)
		p.Do("a", 162199377, 21)
		p.Do("b", 104190146, 1)
		p.Do("b", 182843426, 2)
		p.Do("b", 120525145, 3)
		p.Do("b", 173251752, 1)
		p.Do("b", 184913949, 2)
		p.Do("b", 152921628, 3)
		p.Do("b", 101282422, 1)
		p.Do("b", 115850802, 2)
		p.Do("b", 149119190, 3)
		p.Do("b", 112882941, 1)
		p.Do("b", 143799247, 2)
		p.Do("b", 175451810, 3)
		p.Do("b", 176225524, 1)
		p.Do("b", 179773376, 2)
		p.Do("b", 190276395, 3)
		p.Do("b", 194343982, 1)
		p.Do("b", 126970958, 2)
		p.Do("b", 161265468, 3)
		p.Do("b", 187529912, 1)
		p.Do("b", 196754402, 2)
		p.Do("b", 120237066, 3)
		p.Do("b", 180313910, 1)
		p.Do("b", 166273288, 2)
		p.Do("b", 130227508, 3)
		p.Do("b", 103422820, 1)
		p.Do("b", 180300433, 2)
		p.Do("b", 124151814, 3)
		p.Do("b", 187925483, 1)
		p.Do("b", 141253289, 2)
		p.Do("b", 153496206, 3)
		p.Do("c", 101682554, 291)
		p.Do("c", 164521958, 43728)
		p.Do("c", 115014893, 953928)
		p.Do("c", 180635778, 291)
		p.Do("c", 129645761, 43728)
		p.Do("c", 140252756, 953928)
		p.Do("c", 110903683, 291)
		p.Do("c", 119599310, 43728)
		p.Do("c", 185103773, 953928)
		p.Do("c", 124229536, 291)
		p.Do("c", 149801011, 43728)
		p.Do("c", 192093762, 953928)
		p.Do("c", 133897063, 291)
		p.Do("c", 133178317, 43728)
		p.Do("c", 165721746, 953928)
		p.Do("c", 157879357, 291)
		p.Do("c", 174891001, 43728)
		p.Do("c", 138283197, 953928)
		p.Do("c", 112315652, 291)
		p.Do("c", 114704530, 43728)
		p.Do("c", 128739744, 953928)
		p.Do("c", 131387105, 291)
		p.Do("c", 122631122, 43728)
		p.Do("c", 114411334, 953928)
		p.Do("c", 109418631, 291)
		p.Do("c", 154896232, 43728)
		p.Do("c", 120464821, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
	}
	cancel()
	<-p.Done()
}

func BenchmarkDoSgContractor(b *testing.B) {
	ctx, cancel := context.WithCancel(context.TODO())
	p := subcontract.NewContractor(ctx,
		subcontract.WithSlots(64),
		subcontract.WithContractor(subcontract.Sg),
	)
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		p.Do("a", 126508028, 21432)
		p.Do("a", 195276497, 2143)
		p.Do("a", 165002907, 21)
		p.Do("a", 145383777, 21432)
		p.Do("a", 189910665, 2143)
		p.Do("a", 163559177, 21)
		p.Do("a", 193291910, 21432)
		p.Do("a", 196625384, 2143)
		p.Do("a", 127931408, 21)
		p.Do("a", 183721869, 21432)
		p.Do("a", 162093163, 2143)
		p.Do("a", 103750125, 21)
		p.Do("a", 163587716, 21432)
		p.Do("a", 103329297, 2143)
		p.Do("a", 113311845, 21)
		p.Do("a", 102902772, 21432)
		p.Do("a", 178049384, 2143)
		p.Do("a", 145409259, 21)
		p.Do("a", 192537932, 21432)
		p.Do("a", 130609642, 2143)
		p.Do("a", 171548844, 21)
		p.Do("a", 126836499, 21432)
		p.Do("a", 102375304, 2143)
		p.Do("a", 165852391, 21)
		p.Do("a", 133532095, 21432)
		p.Do("a", 129246971, 2143)
		p.Do("a", 141447395, 21)
		p.Do("a", 109140482, 21432)
		p.Do("a", 137656821, 2143)
		p.Do("a", 162199377, 21)
		p.Do("b", 104190146, 1)
		p.Do("b", 182843426, 2)
		p.Do("b", 120525145, 3)
		p.Do("b", 173251752, 1)
		p.Do("b", 184913949, 2)
		p.Do("b", 152921628, 3)
		p.Do("b", 101282422, 1)
		p.Do("b", 115850802, 2)
		p.Do("b", 149119190, 3)
		p.Do("b", 112882941, 1)
		p.Do("b", 143799247, 2)
		p.Do("b", 175451810, 3)
		p.Do("b", 176225524, 1)
		p.Do("b", 179773376, 2)
		p.Do("b", 190276395, 3)
		p.Do("b", 194343982, 1)
		p.Do("b", 126970958, 2)
		p.Do("b", 161265468, 3)
		p.Do("b", 187529912, 1)
		p.Do("b", 196754402, 2)
		p.Do("b", 120237066, 3)
		p.Do("b", 180313910, 1)
		p.Do("b", 166273288, 2)
		p.Do("b", 130227508, 3)
		p.Do("b", 103422820, 1)
		p.Do("b", 180300433, 2)
		p.Do("b", 124151814, 3)
		p.Do("b", 187925483, 1)
		p.Do("b", 141253289, 2)
		p.Do("b", 153496206, 3)
		p.Do("c", 101682554, 291)
		p.Do("c", 164521958, 43728)
		p.Do("c", 115014893, 953928)
		p.Do("c", 180635778, 291)
		p.Do("c", 129645761, 43728)
		p.Do("c", 140252756, 953928)
		p.Do("c", 110903683, 291)
		p.Do("c", 119599310, 43728)
		p.Do("c", 185103773, 953928)
		p.Do("c", 124229536, 291)
		p.Do("c", 149801011, 43728)
		p.Do("c", 192093762, 953928)
		p.Do("c", 133897063, 291)
		p.Do("c", 133178317, 43728)
		p.Do("c", 165721746, 953928)
		p.Do("c", 157879357, 291)
		p.Do("c", 174891001, 43728)
		p.Do("c", 138283197, 953928)
		p.Do("c", 112315652, 291)
		p.Do("c", 114704530, 43728)
		p.Do("c", 128739744, 953928)
		p.Do("c", 131387105, 291)
		p.Do("c", 122631122, 43728)
		p.Do("c", 114411334, 953928)
		p.Do("c", 109418631, 291)
		p.Do("c", 154896232, 43728)
		p.Do("c", 120464821, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 144734881, 291)
		p.Do("c", 124655527, 43728)
		p.Do("c", 160070131, 953928)
		p.Do("c", 144734881, 291)
	}
	cancel()
	<-p.Done()
}
